version: '3.8'

services:
  ml-worker:
    build: ../ml-service
    container_name: ${COMPOSE_PROJECT_NAME}-ml-worker-1
    depends_on:
      kafka:
        condition: service_healthy
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      KAFKA_TOPIC: ${KAFKA_TOPIC}
      KAFKA_GROUP_ID: ${KAFKA_GROUP_ID}
      DATABASE_URL: ${DATABASE_URL}
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET}
      ML_MOCK_MODE: ${ML_MOCK_MODE}
      ML_MOCK_DELAY: ${ML_MOCK_DELAY}
      TRIPSR_DEVICE: ${TRIPSR_DEVICE}
      TRIPSR_MODEL_PATH: ${TRIPSR_MODEL_PATH}
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FORMAT: ${LOG_FORMAT}
      SERVICE_NAME: ${SERVICE_NAME}
      ENVIRONMENT: ${ENVIRONMENT}
      APP_VERSION: ${APP_VERSION}
      PYTHONUNBUFFERED: ${PYTHONUNBUFFERED}
      MALLOC_ARENA_MAX: ${MALLOC_ARENA_MAX}
      OMP_NUM_THREADS: ${OMP_NUM_THREADS}
      MKL_NUM_THREADS: ${MKL_NUM_THREADS}
      TORCH_NUM_THREADS: ${TORCH_NUM_THREADS}
    networks:
      - modelforge-net
    mem_limit: ${ML_WORKER_MEM_LIMIT}
    cpus: ${ML_WORKER_CPU_LIMIT}
    restart: always
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - logging=promtail

  minio-seed:
    build: ../ml-service
    container_name: ${COMPOSE_PROJECT_NAME}-minio-seed
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: python scripts/seed_minio.py
    environment:
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET}
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FORMAT: text
      SERVICE_NAME: modelforge-minio-seed
      ENVIRONMENT: ${ENVIRONMENT}
    networks:
      - modelforge-net
    mem_limit: ${MINIO_SEED_MEM_LIMIT}
    cpus: ${MINIO_SEED_CPU_LIMIT}
    restart: "no"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - logging=promtail
